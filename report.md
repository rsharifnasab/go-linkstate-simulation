# گزارش پروژه شبیه‌سازی پروتکل link state با golang 

+ روزبه شریف نسب 
+ شهریار مربی



در این گزارش میخواهیم شرح مختصری بر پیاده‌سازی شبیه‌ساز پروتکل link state داشته باشیم. برای پیاده سازی از زبان golang استفاده شد. مزیت این زبان، امکانات راحت‌تر کار با tcp و البته سهولت مثال‌زدنی ساخت و مدیریت ترد‌های جدید و سبک وزن بود. مثلا با کمک چنل‌ها، امکان سنکرون کردن ترد‌های manager و ارسال پکت های مربوطه در زمان مناسب بسیار ساده بود. 

مساله‌ای که متاسفانه به سادگی حل نشد، خواندن از udp بود. برای خواندن از یک کانکشن udp دچار مشکل شدیم! نهایتا راه حلی که وجود داشت این بود که یک بافر با سایز معلوم (در اینجا ۱۰۲۴×۱۰۲۴) بگیریم و امیدوار باشیم داده بزرگ‌تر نشود! با توجه به اینکه متد های خواندن از udp، به همراه داده، آدرس فرستنده را نیز برمی‌گرداندند، خواندن از آن‌ها با readerهای معلوم باعث از دست رفتن این داده می‌شود. البته در برخی قسمت‌ها مشکل ساز نبود اما برای هماهنگی اصلا در udp از reader استفاده نشد.

متاسفانه با توجه به استفاده‌ی کم در جهان از این پروتکل دوست‌داشتنی، سوال و جواب‌های stackoverflow و آموزش‌های دیگر چندان کافی نبود وگرنه احتمالا روش بهتری نیز هست! البته در این موضوع، تازه بودن زبان گو هم بی‌تاثیر نیست.



مشکل دیگری که برخوردیم، تمایز دادن پکت‌های دریافت شده از udp بود. در واقع مساله این است که رد و بدل کردن ackها بین router ها و سپس lspها به درستی انجام می‌شوند. اما جایی که روتد می‌خواهد پکت‌های data که قرار است رد و بدل شوند را بگیرد، با پکت‌های lsp تکراری مواجه می‌شود. برای حل این مشکل گفتیم در صورتی که پکت lsp دریافت شد آن را drop کرده و مجددا منتظر پکت داده‌ای بماند.



نکته قابل توجه دیگر، لاگ‌ها بودند. لاگ‌های manager در stderr به شکل مستقیم پرینت شدند. این لاگ‌ها به نسبت کوتاه و بدون نکته خاصی هستند.

اما از آن‌جا که درون یک پروسه، پروسه دیگری را باز کرده بودیم، پروسه‌های روتر خروجی‌شان هیچ‌جا چاپ نمیشد. برای حل این مشکل، در همان پروسه اصلی منیجر، یک reader روی stderr روتر ها باز کردیم تا لاگ‌هایشان به این ترتیب قابل مشاهده باشد. اما مدیریت این روش سحت بود. این روش بعدا برای دیباگ (در صورت panic) استفاده شد. به این صورت که در صورتی که پروسه panic کند، حتما لاگ در stderr چاپ می‌شود و نه جای دیگر، بنابراین در manager آن را از روی reader دریافت می‌کردیم  و چاپ می‌کردیم. با پایدار شدن پیاده‌سازی برنامه نیاز به این قسمت وجود ندارد اما همچنان وجود دارد.

اما برای لاگ‌های اصلی، برای اینکه لاگ روتر ها قابل تشخیص باشد، هر روتر یک فایل به نام اندیسش (که از منیجر می‌گیرد) احداث می‌کند و در آن لاگ‌هایش را می‌نویسد. برای این منظور از change log file خود پکیج log در زبان استفاده شد.



همچنین خلاقیت دیگری که در log ها زده شد این بود که هر لاگ تگ مناسب دارد، در نتیجه می‌توان با یک grep ساده، هر قسمت از لاگ روتر که مد نظر است را جدا کرد. مثلا فقط یک روتر یا دریافت lsp های همه روتر ها یا ... 



